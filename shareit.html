<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share File Lokal</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        /* Import Poppins font */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Poppins', sans-serif;
    line-height: 1.6;
    background: #fafafa;
    min-height: 100vh;
    padding: 0;
}

.container {
    max-width: 100%;
    margin: 0;
    background: white;
    padding: 2rem;
    position: relative;
    min-height: 100vh;
}

h1 {
    text-align: center;
    color: #111;
    margin-bottom: 2rem;
    font-weight: 700;
    font-size: 2.5rem;
    text-transform: uppercase;
}

.tabs {
    display: flex;
    margin-bottom: 2rem;
    background: #f0f0f0;
    padding: 0.5rem;
    gap: 0.5rem;
}

.tab {
    padding: 1rem 2rem;
    background: white;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    color: #333;
    transition: all 0.3s ease;
    box-shadow: 4px 4px 0 #000;
    border: 2px solid #000;
}

.tab:hover {
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0 #000;
}

.tab.active {
    background: #000;
    color: white;
    box-shadow: none;
    transform: translate(4px, 4px);
}

.tab-content {
    display: none;
    padding: 2rem;
    background: white;
    box-shadow: 8px 8px 0 #000;
    border: 2px solid #000;
}

.tab-content.active {
    display: block;
}

.connection-info {
    margin-bottom: 2rem;
    text-align: center;
}

.connection-id {
    font-size: 1.5rem;
    font-weight: 600;
    color: #000;
    background: #ffd700;
    padding: 1rem 2rem;
    display: inline-block;
    margin: 1rem 0;
    box-shadow: 4px 4px 0 #000;
    border: 2px solid #000;
}

.file-input-wrapper {
    margin: 2rem 0;
    text-align: center;
}

.file-input-wrapper button {
    padding: 1rem 2rem;
    background: #ff6b6b;
    color: white;
    border: 2px solid #000;
    box-shadow: 4px 4px 0 #000;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
    transition: all 0.3s ease;
}

.file-input-wrapper button:hover {
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0 #000;
}

.file-input-wrapper input[type="file"] {
    display: none;
}

.selected-files {
    margin: 2rem 0;
}

.file-item {
    background: #f8f9fa;
    padding: 1.5rem;
    margin: 1rem 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 4px 4px 0 #000;
    border: 2px solid #000;
}

#recipientId {
    width: 100%;
    padding: 1rem;
    margin: 1rem 0;
    border: 2px solid #000;
    font-family: 'Poppins', sans-serif;
    box-shadow: 4px 4px 0 #000;
}

#sendButton {
    width: 100%;
    padding: 1rem;
    background: #4ade80;
    color: #000;
    border: 2px solid #000;
    box-shadow: 4px 4px 0 #000;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    transition: all 0.3s ease;
}

#sendButton:hover:not(:disabled) {
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0 #000;
}

#sendButton:disabled {
    background: #d1d5db;
    cursor: not-allowed;
    box-shadow: none;
}

.status {
    margin: 1rem 0;
    padding: 1rem;
    text-align: center;
    border: 2px solid #000;
    box-shadow: 4px 4px 0 #000;
}

.status.success {
    background: #86efac;
    color: #000;
}

.status.error {
    background: #fecaca;
    color: #000;
}

.progress-bar {
    width: 100%;
    height: 1rem;
    background: #f0f0f0;
    margin: 1rem 0;
    border: 2px solid #000;
    overflow: hidden;
}

.progress {
    width: 0%;
    height: 100%;
    background: #4ade80;
    transition: width 0.3s ease;
}

.download-button {
    background: #4ade80;
    color: #000;
    border: 2px solid #000;
    padding: 0.75rem 1.5rem;
    box-shadow: 4px 4px 0 #000;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
    transition: all 0.3s ease;
}

.download-button:hover {
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0 #000;
}

.file-info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.file-name {
    font-weight: 600;
    color: #000;
}

.file-size {
    color: #666;
    font-size: 0.9rem;
}

.info-text {
    color: #666;
    font-style: italic;
    margin: 1rem 0;
    text-align: center;
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        padding: 1rem;
    }
    
    .tabs {
        flex-wrap: wrap;
    }
    
    .tab {
        flex: 1 1 calc(50% - 0.5rem);
        text-align: center;
    }
    
    .file-item {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    h1 {
        font-size: 2rem;
    }
    
    .connection-id {
        font-size: 1.2rem;
        padding: 0.75rem 1.5rem;
    }
}

@media (max-width: 480px) {
    .tab {
        flex: 1 1 100%;
    }
    
    .connection-id {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }
    
    h1 {
        font-size: 1.5rem;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <h1>Share File Lokal</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('send')">Kirim File</button>
            <button class="tab" onclick="switchTab('receive')">Terima File</button>
        </div>

        <div id="sendTab" class="tab-content active">
            <div class="connection-info">
                <h3>Kode Koneksi Anda:</h3>
                <p class="connection-id" id="myId">Menghubungkan...</p>
                <button id="reconnectButton" onclick="reconnect()" style="display: none;">Hubungkan Ulang</button>
            </div>

            <div class="file-input-wrapper">
                <button>Pilih File</button>
                <input type="file" id="fileInput" multiple>
            </div>

            <div class="selected-files" id="selectedFiles"></div>

            <input type="text" id="recipientId" placeholder="Masukkan kode koneksi penerima">
            <button onclick="sendFiles()" id="sendButton" disabled>Kirim File</button>

            <div id="sendStatus" class="status"></div>
            <div class="progress-bar">
                <div class="progress" id="sendProgress"></div>
            </div>
        </div>

        <div id="receiveTab" class="tab-content">
            <div class="connection-info">
                <h3>Kode Koneksi Anda:</h3>
                <p class="connection-id" id="myId2">Menghubungkan...</p>
            </div>

            <div id="receiveStatus" class="status"></div>
            <div class="progress-bar">
                <div class="progress" id="receiveProgress"></div>
            </div>

            <div class="file-list" id="receivedFiles">
                <h3>File yang Diterima:</h3>
                <p class="info-text">(Klik tombol Download untuk menyimpan file)</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
let peer = null;
let conn = null;
let fileQueue = [];
let currentFile = null;
let receivedSize = 0;
let totalSize = 0;
let fileBuffer = [];
let myPeerId = null;
const chunksSize = 16384; // 16KB chunks

// Initialize PeerJS connection
function initPeer() {
    showStatus('info', 'Menghubungkan ke server...');
    
    // Generate random ID for this peer
    myPeerId = generatePeerId();
    
    // Create new Peer connection
    peer = new Peer(myPeerId, {
        host: 'peerjs-server.herokuapp.com',
        secure: true,
        port: 443,
        debug: 1,
        config: {
            'iceServers': [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        }
    });

    // Handle successful connection
    peer.on('open', (id) => {
        document.getElementById('myId').textContent = id;
        document.getElementById('myId2').textContent = id;
        showStatus('success', 'Terhubung ke server! Siap untuk berbagi file');
    });

    // Handle incoming connections
    peer.on('connection', handleIncomingConnection);

    // Handle connection errors
    peer.on('error', handlePeerError);

    // Handle disconnection
    peer.on('disconnected', () => {
        showStatus('error', 'Terputus dari server. Mencoba menghubungkan kembali...');
        peer.reconnect();
    });
}

// Generate a random peer ID
function generatePeerId() {
    const chars = '123456789ABCDEFGHIJKLMNPQRSTUVWXYZ';
    let result = '';
    for (let i = 0; i < 6; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

// Handle incoming peer connections
function handleIncomingConnection(connection) {
    // Close existing connection if any
    if (conn) {
        conn.close();
    }
    
    conn = connection;
    setupConnectionHandlers();
    showStatus('success', 'Terhubung dengan peer!');
}

// Handle peer errors
function handlePeerError(error) {
    console.error('Peer error:', error);
    let message = 'Terjadi kesalahan koneksi. ';
    
    switch (error.type) {
        case 'peer-unavailable':
            message += 'Peer tidak ditemukan. Pastikan kode koneksi benar.';
            break;
        case 'network':
            message += 'Masalah jaringan. Periksa koneksi internet Anda.';
            break;
        case 'server-error':
            message += 'Tidak dapat terhubung ke server. Coba lagi nanti.';
            break;
        default:
            message += 'Silakan coba lagi.';
    }
    
    showStatus('error', message);
}

// Set up handlers for peer connection
function setupConnectionHandlers() {
    if (!conn) return;

    conn.on('data', handleIncomingData);
    
    conn.on('open', () => {
        showStatus('success', 'Koneksi siap untuk transfer file');
    });

    conn.on('close', () => {
        showStatus('info', 'Koneksi tertutup');
        conn = null;
    });

    conn.on('error', (err) => {
        showStatus('error', 'Error koneksi: ' + err.message);
        conn = null;
    });
}

// Handle incoming data
function handleIncomingData(data) {
    if (data.type === 'file-header') {
        // New file incoming
        currentFile = {
            name: data.fileName,
            size: data.fileSize,
            type: data.fileType
        };
        receivedSize = 0;
        totalSize = data.fileSize;
        fileBuffer = [];
        showStatus('info', `Menerima file: ${data.fileName}`);
        
    } else if (data.type === 'file-chunk') {
        // Receive file chunk
        fileBuffer.push(data.chunk);
        receivedSize += data.chunk.byteLength;
        updateProgress('receive', (receivedSize / totalSize) * 100);

        // Check if file is complete
        if (receivedSize === totalSize) {
            completeFileReceive();
        }
    }
}

// Complete file receive process
function completeFileReceive() {
    const blob = new Blob(fileBuffer, { type: currentFile.type });
    const url = URL.createObjectURL(blob);
    
    // Create file item in received files list
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.innerHTML = `
        <div class="file-info">
            <span class="file-name">${currentFile.name}</span>
            <span class="file-size">(${formatFileSize(currentFile.size)})</span>
        </div>
        <div class="file-actions">
            <a href="${url}" download="${currentFile.name}">
                <button class="download-button">Download</button>
            </a>
        </div>
    `;
    
    document.getElementById('receivedFiles').appendChild(fileItem);
    showStatus('success', `File ${currentFile.name} siap didownload!`);
    
    // Reset file receive state
    fileBuffer = [];
    currentFile = null;
    updateProgress('receive', 0);
}

// Connect to another peer
function connectToPeer(peerId) {
    if (!peer) {
        showStatus('error', 'Tidak terhubung ke server. Refresh halaman.');
        return;
    }

    // Prevent self-connection
    if (peerId === myPeerId) {
        showStatus('error', 'Tidak dapat terhubung ke diri sendiri');
        return;
    }

    // Close existing connection
    if (conn) {
        conn.close();
    }

    try {
        conn = peer.connect(peerId, {
            reliable: true,
            serialization: 'binary'
        });
        
        setupConnectionHandlers();
    } catch (err) {
        showStatus('error', 'Gagal membuat koneksi: ' + err.message);
    }
}

// Send files to peer
function sendFiles() {
    if (!conn || !conn.open) {
        showStatus('error', 'Tidak ada koneksi ke peer');
        return;
    }

    if (fileQueue.length === 0) {
        showStatus('error', 'Tidak ada file yang dipilih');
        return;
    }

    sendNextFile();
}

// Send next file in queue
function sendNextFile() {
    const file = fileQueue[0];
    currentFile = file;
    
    // Send file header first
    conn.send({
        type: 'file-header',
        fileName: file.name,
        fileSize: file.size,
        fileType: file.type
    });

    // Setup file reader
    const reader = new FileReader();
    let offset = 0;

    reader.onload = (e) => {
        if (!conn.open) {
            showStatus('error', 'Koneksi terputus');
            return;
        }

        const chunk = e.target.result;
        conn.send({
            type: 'file-chunk',
            chunk: chunk
        });

        offset += chunk.byteLength;
        updateProgress('send', (offset / file.size) * 100);

        if (offset < file.size) {
            // Read next chunk
            readNextChunk();
        } else {
            // File complete, remove from queue
            fileQueue.shift();
            updateProgress('send', 0);
            
            if (fileQueue.length > 0) {
                // Send next file if queue not empty
                sendNextFile();
            } else {
                showStatus('success', 'Semua file terkirim!');
            }
        }
    };

    reader.onerror = (error) => {
        showStatus('error', 'Error membaca file: ' + error.message);
    };

    // Read file chunks
    function readNextChunk() {
        const slice = file.slice(offset, offset + chunksSize);
        reader.readAsArrayBuffer(slice);
    }

    // Start reading
    readNextChunk();
}

// UI update functions
function showStatus(type, message) {
    const elements = ['sendStatus', 'receiveStatus'];
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = message;
            element.className = `status ${type}`;
        }
    });
}

function updateProgress(type, percentage) {
    const progressBar = document.getElementById(`${type}Progress`);
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Tab switching
function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });

    const activeTab = tabName === 'send' ? 'sendTab' : 'receiveTab';
    document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');
    document.getElementById(activeTab).classList.add('active');
}

// File input handler
document.getElementById('fileInput').addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    fileQueue = files;
    
    const selectedFiles = document.getElementById('selectedFiles');
    selectedFiles.innerHTML = '';
    
    files.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <div class="file-info">
                <span class="file-name">${file.name}</span>
                <span class="file-size">(${formatFileSize(file.size)})</span>
            </div>
            <button onclick="removeFile('${file.name}')" class="remove-button">Hapus</button>
        `;
        selectedFiles.appendChild(fileItem);
    });

    document.getElementById('sendButton').disabled = files.length === 0;
    showStatus('info', `${files.length} file dipilih`);
});

// Remove file from queue
function removeFile(fileName) {
    fileQueue = fileQueue.filter(file => file.name !== fileName);
    
    const selectedFiles = document.getElementById('selectedFiles');
    const fileItems = selectedFiles.getElementsByClassName('file-item');
    for (let i = fileItems.length - 1; i >= 0; i--) {
        if (fileItems[i].querySelector('.file-name').textContent === fileName) {
            fileItems[i].remove();
        }
    }
    
    document.getElementById('sendButton').disabled = fileQueue.length === 0;
    showStatus('info', fileQueue.length > 0 ? `${fileQueue.length} file dipilih` : 'Tidak ada file dipilih');
}

// Recipient ID input handler
document.getElementById('recipientId').addEventListener('input', (e) => {
    const peerId = e.target.value.trim().toUpperCase();
    e.target.value = peerId;
    
    if (peerId && peerId !== myPeerId) {
        connectToPeer(peerId);
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    initPeer();
});

// Clean up on page unload
window.addEventListener('beforeunload', () => {
    if (peer) {
        peer.destroy();
    }
});
    </script>
</body>
</html>